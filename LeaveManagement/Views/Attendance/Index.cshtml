@model List<LeaveManagement.VM.AttendanceReportViewModel>
@{
    ViewData["Title"] = "Attendance";
    Layout = "~/Views/Shared/_EmployeeLayout.cshtml";
    bool hasCheckedIn = ViewBag.HasCheckedIn ?? false;
    bool hasCheckedOut = ViewBag.HasCheckedOut ?? false;
}

<div class="container mt-4">
    <div class="card shadow-sm border-0 mb-4" style="border-radius: 10px;">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                <div>
                  
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">Mark your attendance using the buttons below</p>
                </div>
                <div class="mt-2 mt-sm-0">
                    <form asp-action="CheckIn" method="post" class="d-inline">
                        <input type="hidden" name="imageData" id="checkinImageData" />
                        <button type="button" id="checkInBtn"
                                class="btn btn-success fw-semibold shadow-sm"
                                style="padding:10px 25px;"
                        @(hasCheckedIn ? "disabled=\"disabled\"" : "")>
                            <i class="bi bi-box-arrow-in-right me-1"></i> Check In
                        </button>
                    </form>

                    <form asp-action="CheckOut" method="post" class="d-inline">
                        <input type="hidden" name="imageData" id="checkoutImageData" />
                        <button type="button" id="checkOutBtn"
                                class="btn btn-danger fw-semibold shadow-sm ms-2"
                                style="padding:10px 25px;"
                        @((!hasCheckedIn || hasCheckedOut) ? "disabled=\"disabled\"" : "")>
                            <i class="bi bi-box-arrow-right me-1"></i> Check Out
                        </button>
                    </form>
                </div>
            </div>

            @if (TempData["Message"] != null)
            {
                <div class="alert alert-success mt-2 mb-0 p-2 px-3" role="alert">
                    <i class="bi bi-check-circle-fill me-1"></i> @TempData["Message"]
                </div>
            }
        </div>
    </div>

    <!-- Hidden Camera -->
    <video id="video" width="320" height="240" autoplay playsinline style="display:none;"></video>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

    <div class="card shadow-sm border-0" style="border-radius: 10px;">
        <div class="card-header bg-light border-0">
            <h5 class="fw-bold text-secondary mb-0">
                <i class="bi bi-clipboard-data me-2"></i> Your Attendance Report
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="attendanceTable" class="table table-bordered table-striped align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Checked In Time</th>
                            <th>Checked Out Time</th>
                            <th>Checked In Image</th>
                            <th>Checked Out Image</th>
                            <th>Working Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.CheckedInTime.ToString("dd-MMM-yyyy hh:mm tt")</td>
                                    <td>@(item.CheckedOutTime.HasValue ? item.CheckedOutTime.Value.ToString("dd-MMM-yyyy hh:mm tt") : "-")</td>

                                    <td>
                                        @(string.IsNullOrEmpty(item.CheckedInImage)
                                            ? "-"
                                            : Html.Raw($"<img src='{item.CheckedInImage}' width='70' height='70' class='rounded shadow-sm' alt='Check In' />"))
                                    </td>

                                    <td>
                                        @(string.IsNullOrEmpty(item.CheckedOutImage)
                                            ? "-"
                                            : Html.Raw($"<img src='{item.CheckedOutImage}' width='70' height='70' class='rounded shadow-sm' alt='Check Out' />"))
                                    </td>

                                    <td>@(item.WorkingHours.HasValue ? $"{item.WorkingHours.Value:F2} hrs" : "-")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <script>
        $(document).ready(function () {
            // ✅ DataTable initialization
            if ($('#attendanceTable').length) {
                $('#attendanceTable').DataTable({
                    order: [[0, "desc"]],
                    columnDefs: [{ orderable: false, targets: [2, 3] }],
                    deferRender: true,
                    pageLength: 10
                });
            }

            // ✅ Camera setup
            let video = document.getElementById("video");
            let canvas = document.getElementById("canvas");
            let context = canvas.getContext("2d");
            let cameraAllowed = false;
            let currentStream = null;
            let permissionStatus = null;

            async function startCamera() {
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = currentStream;
                    cameraAllowed = true;
                    await video.play();
                } catch (err) {
                    cameraAllowed = false;
                    alert("Camera access is required to mark attendance. Please enable your camera.");
                }
            }

            async function stopCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                cameraAllowed = false;
            }

            async function checkPermission() {
                try {
                    permissionStatus = await navigator.permissions.query({ name: "camera" });

                    // Update cameraAllowed based on current state
                    cameraAllowed = permissionStatus.state === "granted";

                    // 🔄 Watch for permission changes
                    permissionStatus.onchange = async () => {
                        if (permissionStatus.state === "granted") {
                            await startCamera();
                        } else {
                            await stopCamera();
                            alert("Camera permission has been revoked. Please allow camera again to continue.");
                        }
                    };
                } catch (err) {
                    // Fallback if Permissions API unsupported
                    await startCamera();
                }
            }

            async function initCamera() {
                await checkPermission();

                // If granted initially
                if (cameraAllowed) {
                    await startCamera();
                } else {
                    alert("Please allow camera access to mark your attendance.");
                }
            }

            initCamera();

            function captureCompressedImage() {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                return canvas.toDataURL("image/jpeg", 0.5);
            }

            async function handleAttendance(btn, hiddenFieldId, formElement, confirmText) {
                // 🔒 Recheck camera permission right before submission
                if (permissionStatus && permissionStatus.state !== "granted") {
                    alert("Camera permission is not active. Please allow your camera again.");
                    return;
                }

                if (!cameraAllowed || !currentStream) {
                    alert("Camera not available or permission revoked. Attendance cannot be marked.");
                    return;
                }

                if (confirmText && !confirm(confirmText)) return;

                btn.prop("disabled", true).text("Processing...");
                await new Promise(resolve => setTimeout(resolve, 200));

                const imageData = captureCompressedImage();
                document.getElementById(hiddenFieldId).value = imageData;

                formElement.submit();
            }

            $("#checkInBtn").on("click", async function () {
                const btn = $(this);
                await handleAttendance(btn, "checkinImageData", btn.closest("form")[0]);
            });

            $("#checkOutBtn").on("click", async function () {
                const btn = $(this);
                await handleAttendance(btn, "checkoutImageData", btn.closest("form")[0], "Are you sure you want to check out?");
            });

            window.addEventListener("beforeunload", () => {
                stopCamera();
            });
        });
    </script>
}

